<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StyleHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base layout */
        :root{ --accent:#007BFF; --danger:#dc3545; }
        body { 
            font-family: Arial, sans-serif; 
            margin:0; 
            padding:0;
            background:#f4f4f4;
            color:#222;
        }
        .admin-navbar { 
            display:flex; 
            justify-content:space-between;
            align-items:center;
            background:#fff; 
            color:#0f1788; 
            padding:12px 16px;
            box-shadow:0 1px 2px rgba(0,0,0,0.04);
        }
        .admin-navbar a { color:#000; text-decoration:none; }
        .admin-container { padding:16px; }
        .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }

        /* Buttons */
        .btn { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; display:inline-block; }
        .btn-primary { background:var(--accent); color:#fff; }
        .btn-outline { background:transparent; color:var(--accent); border:1px solid var(--accent); }
        .btn-sm { padding:6px 8px; font-size:13px; }
        .btn-danger { background:var(--danger); color:#fff; }

        .card { background:#fff; border-radius:8px; padding:12px; box-shadow:0 3px 8px rgba(0,0,0,0.03); }
        .card-header h3 { margin:0 0 6px 0; }

        /* Table wrapper to allow horizontal scroll on small screens */
        .table-responsive { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:800px; }
        th, td { padding:10px 8px; border:1px solid #eee; text-align:left; vertical-align:middle; }
    td img { max-width:60px; height:auto; display:block; }
    /* Keep description column from expanding tables too much on desktop */
    td[data-label="Description"] { max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn .btn-text { margin-left:8px; }

        /* Action buttons container */
        .action-buttons { display:flex; gap:6px; }

        /* Modal */
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; padding:12px; }
        .modal-content { background:#fff; padding:16px; border-radius:8px; width:520px; max-width:100%; box-sizing:border-box; position:relative; }
        .close { position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px; border:none; background:none; }
        .form-group { margin-bottom:10px; }
        .form-control { width:100%; padding:8px; box-sizing:border-box; }

        /* Mobile: convert table rows to stacked cards for readability */
        @media (max-width: 760px) {
            .page-header { flex-direction:column; align-items:stretch; }
            .page-header .btn { width:100%; }
            table { min-width:0; border:0; }
            thead { display:none; }
            tr { display:block; margin-bottom:12px; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.03); padding:10px; }
            td { display:flex; justify-content:space-between; align-items:center; border:0; padding:6px 0; }
            td + td { border-top:1px solid #f0f0f0; }
            td[data-label] { padding:8px 0; }
            td[data-label]::before { content: attr(data-label) ": "; font-weight:600; color:#555; display:inline-block; width:110px; }
            td img { max-width:48px; margin-right:8px; }
            .action-buttons { flex-direction:column; }
            .action-buttons .btn { width:100%; }
            /* hide button text on very small screens to save space */
            .btn .btn-text { display:none; }
            .modal-content { width:100%; padding:12px; }
        }
    </style>
</head>
<body>

<nav class="admin-navbar">
    <div class="navbar-brand">StyleHub Admin</div>
    <div class="navbar-actions">
        <a href="/admin/login" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
</nav>

<div class="admin-container">
    <header class="page-header">
        <h1>Product Management</h1>
        <button class="btn btn-primary" id="addProductBtn"><i class="fas fa-plus"></i> Add New Product</button>
    </header>

    <div class="content">
        <div class="card">
            <div class="card-header"><h3>Products</h3></div>
            <div class="card-body">
                <div class="table-responsive">
                <table id="productsTable">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Rate</th>
                        <th>Price</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    <!-- Products loaded via JS -->
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <button class="close">&times;</button>
        <h3>Add New Product</h3>
        <form id="productForm">
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="productName" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="productCategory" class="form-control" required>
                    <option value="">Select a category</option>
                    <option value="men">Men</option>
                    <option value="women">Women</option>
                    <option value="neutral">Neutral</option>
                    <option value="electronics">Electronics</option>
                </select>
            </div>
            <div class="form-group">
                <label>Rate (1-5)</label>
                <input type="number" id="productRate" class="form-control" min="1" max="5" step="0.5" value="1" required>
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" id="productPrice" class="form-control" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" class="form-control" rows="3" placeholder="Short product description"></textarea>
            </div>
            <div class="form-group">
                <label>Image</label>
                <input type="file" id="productImage" class="form-control" accept="image/*">
            </div>
            <div style="margin-top:10px;">
                <button type="submit" class="btn btn-primary">Save Product</button>
                <button type="button" class="btn btn-outline" id="cancelBtn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit/Delete functionality -->
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const tbody = document.getElementById("productsTableBody");
        const addProductBtn = document.getElementById("addProductBtn");
        const modal = document.getElementById("productModal");
        const closeBtn = modal.querySelector(".close");
        const cancelBtn = modal.querySelector("#cancelBtn");
        const form = modal.querySelector("#productForm");

        let editingProductId = null;

        async function loadProducts() {
            tbody.innerHTML = "";
            try {
                const res = await fetch("/admin/dashboard/products");
                const products = await res.json();

                products.forEach(product => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td data-label="ID">${product.id}</td>
                    <td data-label="Image"><img src="${product.image_url || ''}" alt="${product.name}" width="50"></td>
                    <td data-label="Name">${product.name}</td>
                    <td data-label="Category">${product.category}</td>
                    <td data-label="Rate">${product.rate}</td>
                    <td data-label="Price">$${product.price}</td>
                    <td data-label="Description">${product.description ? product.description : ''}</td>
                    <td data-label="Actions">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary editBtn" data-id="${product.id}"><i class="fas fa-edit"></i><span class="btn-text"> Edit</span></button>
                            <button class="btn btn-sm btn-danger deleteBtn" data-id="${product.id}"><i class="fas fa-trash"></i><span class="btn-text"> Delete</span></button>
                        </div>
                    </td>
                `;
                    tbody.appendChild(row);
                });

                document.querySelectorAll(".editBtn").forEach(btn => {
                    btn.addEventListener("click", () => editProduct(Number(btn.dataset.id)));
                });
                document.querySelectorAll(".deleteBtn").forEach(btn => {
                    btn.addEventListener("click", () => deleteProduct(Number(btn.dataset.id)));
                });

            } catch(err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7">Failed to load products</td></tr>`;
            }
        }

        // Add new
        addProductBtn.addEventListener("click", () => {
            editingProductId = null;
            form.reset();
            modal.style.display = "flex";
        });


        closeBtn.addEventListener("click", () => modal.style.display = "none");
        cancelBtn.addEventListener("click", () => modal.style.display = "none");

        // Submit form (Add/Edit)
        form.addEventListener("submit", async e => {
            e.preventDefault();

            const name = document.getElementById("productName").value;
            const category = document.getElementById("productCategory").value;
            const rate = document.getElementById("productRate").value;
            const price = document.getElementById("productPrice").value;
            const description = document.getElementById("productDescription").value;
            const fileInput = document.getElementById('productImage');

            // helper to read file as base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            try {
                if (editingProductId) {
                    // Edit â€” include image if selected
                    const productData = { name, category, rate, price, description };
                    if (fileInput.files && fileInput.files[0]) {
                        const file = fileInput.files[0];
                        const base64 = await fileToBase64(file);
                        productData.imageBase64 = base64;
                        productData.imageFilename = file.name;
                    }
                    await fetch(`/admin/dashboard/products/${editingProductId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // Add
                    const payload = { name, category, rate, price, description };
                    if (fileInput.files && fileInput.files[0]) {
                        const file = fileInput.files[0];
                        const base64 = await fileToBase64(file);
                        payload.imageBase64 = base64;
                        payload.imageFilename = file.name;
                    }

                    await fetch("/admin/dashboard/products", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                }
                modal.style.display = "none";
                loadProducts();
            } catch(err) {
                console.error(err);
            }
        });

        // Edit
        async function editProduct(id) {
            try {
                const res = await fetch(`/admin/dashboard/products`);
                const products = await res.json();
                const product = products.find(p => Number(p.id) === Number(id));
                if (!product) return;

                editingProductId = Number(id);
                document.getElementById("productName").value = product.name;
                document.getElementById("productCategory").value = product.category;
                document.getElementById("productRate").value = product.rate;
                document.getElementById("productPrice").value = product.price;
                document.getElementById("productDescription").value = product.description || '';
                modal.style.display = "flex";
            } catch(err) {
                console.error(err);
            }
        }

        // Delete
        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;
            try {
                await fetch(`/admin/dashboard/products/${id}`, { method: "DELETE" });
                loadProducts();
            } catch(err) {
                console.error(err);
            }
        }

        // Initial load
        await loadProducts();
    });
</script>


</body>
</html>
